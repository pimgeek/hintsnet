<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <script src="./bmob/bmob-min.js"></script>
  <script src="./gv/viz.js"></script>
  <script src="./lib.js"></script>
  <style>
  #output {
    width: 1200px;
    height: 400px;
    overflow: auto;
  }
  </style>
</head>

<body>
  <p id="demo">输入搜索关键词后，点击“借助关键词查询思路”按钮获取思路……</p>
  <!-- 
  <input id="hintPipeSimpleInput" value="A|->|B #tag1 #tag2 @wudi @yutong"></input>
  <button type="button" onclick="addNewHintPipe()">增加思路</button>
  <p></p>
  -->
  <input id="searchKeyword" value="发言者"></input>
  <button type="button" onclick="searchHintPipeByKeyword()">借助关键词查询思路</button>
  <p></p>
  <!--
  <input id="purposeTags" value="#tag1 #tag2"></input>
  <button type="button" onclick="filterHintPipeByTag()">以目的标签过滤思路</button>
  <p></p>
  <input id="authorTags" value="@wudi @yutong"></input>
  <button type="button" onclick="addNewHintPipe()">以用户名标签过滤思路</button>
  <p></p>
  -->
  <input type="hidden" id="hintPipes" value=""></input>
  <p id="debugInfo"></p>
  <p id="output"></p>
  <script>
  var gvParser = new DOMParser();
  var worker;
  var gvResult;

  function updateGraph() {
    if (worker) {
      worker.terminate();
    }

    document.querySelector("#output").classList.add("working");
    document.querySelector("#output").classList.remove("debugInfo");

    worker = new Worker("./gv/worker.js");

    worker.onmessage = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.remove("debugInfo");

      gvResult = e.data;

      updateOutput();
    }

    worker.onerror = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.add("debugInfo");

      var message = e.message === undefined ? "在生成思维引导图的过程中发生了错误。" : e.message;

      var debugInfo = document.querySelector("#debugInfo");
      while (debugInfo.firstChild) {
        debugInfo.removeChild(debugInfo.firstChild);
      }

      document.querySelector("#debugInfo").appendChild(document.createTextNode(message));

      console.error(e);
      e.preventDefault();
    }

    var params = {
      src: document.getElementById("hintPipes").innerText,
      options: {
        engine: "dot",
        format: "svg"
      }
    };

    // Instead of asking for png-image-element directly, which we can't do in a worker,
    // ask for SVG and convert when updating the output.

    if (params.options.format == "png-image-element") {
      params.options.format = "svg";
    }

    worker.postMessage(params);
  }

  function updateOutput() {
    var graph = document.querySelector("#output");

    var svg = graph.querySelector("svg");

    if (svg) {
      graph.removeChild(svg);
    }

    if (!gvResult) {
      return;
    }

    var svg = gvParser.parseFromString(gvResult, "image/svg+xml");
    graph.appendChild(svg.documentElement);
  }

  function renderHintsNetGraph(hintPipeSet, searchKeyword) {
    var hintPipeSetJson = JSON.parse(hintPipeSet);
    var numOfHintPipes = hintPipeSetJson.results.length;
    document.getElementById("debugInfo").innerHTML = "共查询到 " + numOfHintPipes + " 条思路";
    // 循环处理查询到的数据
    var output = 'digraph 关于“' + searchKeyword + '”的思维引导图 { \n' +
      '  rankdir=LR\n' +
      '  graph [fontname="simhei" splines="polyline"]\n' +
      '  edge  [fontname="simhei" arrowsize="0.6"]\n' +
      '  node  [fontname="simhei" fontsize="9px" shape="note" height="0.1" style="filled" fillcolor="khaki1"] \n';
    for (var i = 0; i < numOfHintPipes; i++) {
      output +=
        hintPipeSetJson.results[i]["inPort"] +
        " -> " +
        hintPipeSetJson.results[i]["outPort"] +
        '[label="..." labeltooltip="' + hintPipeSetJson.results[i]["purposeTags"] + '"]' + 
        "\n";
    }
    document.getElementById("hintPipes").innerHTML = output + '} ';
    updateGraph();
  }

  function searchHintPipeByKeyword() {
    var searchKeyword = document.getElementById("searchKeyword").value;
    Bmob.initialize("c545038f6a339960257b2d750f70d8bc", "35574c8136fb3febb7bae62b83cb42ac");
    var hintPipeSet = Bmob.Object.extend("hint_pipe_set");
    Bmob.Cloud.run("findHintPipe", {
      "searchKeyword": document.getElementById("searchKeyword").value
    }, {
      success: function(hintPipeSet) {
        renderHintsNetGraph(hintPipeSet, searchKeyword);
      },
      error: function(error) {
        document.getElementById("debugInfo").innerHTML = "引思管道查询失败: " + error.code + " " + error.message;
      }
    });
  }

  function filterHintPipeByTag() {
    Bmob.initialize("c545038f6a339960257b2d750f70d8bc", "35574c8136fb3febb7bae62b83cb42ac");
    var hintPipeSet = Bmob.Object.extend("hint_pipe_set");
    Bmob.Cloud.run("filterHintPipeByTag", {
      "query": document.getElementById("purposeTags").value
    }, {
      success: function(result) {
        var resJson = JSON.parse(result);
        var numOfHintPipes = resJson.results.length;

        document.getElementById("debugInfo").innerHTML = "共查询到 " + numOfHintPipes + " 条思路";
        // 循环处理查询到的数据
        var output = 'digraph G { \n' +
          '  rankdir=LR\n' +
          '  graph [fontname="simhei" splines="polyline"]\n' +
          '  edge  [fontname="simhei" arrowsize="0.6"]\n' +
          '  node  [fontname="simhei" fontsize="9px" shape="note" height="0.1" style="filled" fillcolor="khaki1"] \n';
        for (var i = 0; i < numOfHintPipes; i++) {
          output +=
            resJson.results[i]["inPort"] +
            " -> " +
            resJson.results[i]["outPort"] +
            "\n";
        }
        document.getElementById("hintPipes").innerHTML = output + '} ';
        updateGraph();
      },
      error: function(error) {
        document.getElementById("error").innerHTML = "查询失败: " + error.code + " " + error.message;
      }
    });
  }
  </script>
</body>

</html>
