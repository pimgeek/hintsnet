<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <script src="./bmob/bmob-min.js"></script>
  <script src="./gv/viz.js"></script>
  <style>
  #output {
    width: 1200px;
    height: 400px;
    overflow: auto;
  }
  </style>
</head>

<body>
  <p id="demo">输入筛选标签后，点击按钮获取思绪……</p>
  <input id="tags" value="#标签1 #标签2"></input>
  <button type="button" onclick="loadDoc()">获取思绪</button>
  <input type="hidden" id="hintPipes"></input>
  <p id="error"></p>
  <p id="output"></p>
  <p id="svg"></p>
  <script>
  var gvParser = new DOMParser();
  var worker;
  var gvResult;

  function updateGraph() {
    if (worker) {
      worker.terminate();
    }

    document.querySelector("#output").classList.add("working");
    document.querySelector("#output").classList.remove("error");

    worker = new Worker("./gv/worker.js");

    worker.onmessage = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.remove("error");

      gvResult = e.data;

      updateOutput();
    }

    worker.onerror = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.add("error");

      var message = e.message === undefined ? "An error occurred while processing the graph input." : e.message;

      var error = document.querySelector("#error");
      while (error.firstChild) {
        error.removeChild(error.firstChild);
      }

      document.querySelector("#error").appendChild(document.createTextNode(message));

      console.error(e);
      e.preventDefault();
    }

    var params = {
      src: document.getElementById("hintPipes").innerText,
      options: {
        engine: "dot",
        format: "svg"
      }
    };

    // Instead of asking for png-image-element directly, which we can't do in a worker,
    // ask for SVG and convert when updating the output.

    if (params.options.format == "png-image-element") {
      params.options.format = "svg";
    }

    worker.postMessage(params);
  }

  function updateOutput() {
    var graph = document.querySelector("#output");

    var svg = graph.querySelector("svg");
    if (svg) {
      graph.removeChild(svg);
    }

    if (!gvResult) {
      return;
    }

    if (1) {
      var svg = gvParser.parseFromString(gvResult, "image/svg+xml");
      graph.appendChild(svg.documentElement);
    } else if (document.querySelector("#format select").value == "png-image-element") {
      var image = Viz.svgXmlToPngImageElement(gvResult);
      graph.appendChild(image);
    } else {
      var text = document.createElement("div");
      text.id = "text";
      text.appendChild(document.createTextNode(gvResult));
      graph.appendChild(text);
    }
  }

  function loadDoc() {
    Bmob.initialize("c545038f6a339960257b2d750f70d8bc", "35574c8136fb3febb7bae62b83cb42ac");
    var hintPipeSet = Bmob.Object.extend("hint_pipe_set");
    Bmob.Cloud.run("filterHintPipeByTag", {
      "query": document.getElementById("tags").value
    }, {
      success: function(results) {
        var numOfHintPipes = 0;
        if (results != "") {
          var lines = results.replace("\r", "\n").replace("\n\n", "\n").split("\n");
          numOfHintPipes = lines.length + 1;
        } else {
          numOfHintPipes = 0;
        }

        document.getElementById("error").innerHTML = "共查询到 " + numOfHintPipes + " 条思路";
        // 循环处理查询到的数据
        var output = 'digraph G { \n' +
          '  rankdir=LR\n' +
          '  graph [fontname="simhei" splines="polyline"]\n' +
          '  edge  [fontname="simhei" arrowsize="0.6"]\n' +
          '  node  [fontname="simhei" fontsize="9px" shape="note" height="0.1" style="filled" fillcolor="khaki1"] \n';
        for (var i = 0; i < lines.length; i++) {
          output += lines[i] + "\n";
        }
        document.getElementById("hintPipes").innerHTML = output + '} ';
        updateGraph();
      },
      error: function(error) {
        document.getElementById("error").innerHTML = "查询失败: " + error.code + " " + error.message;
      }
    });
  }
  </script>
</body>

</html>
